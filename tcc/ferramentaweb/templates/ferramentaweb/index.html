<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoSimula</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'ferramentasweb/styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{% static 'ferramentasweb/images/logo3.png' %}" type="image/png">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <img src="{% static 'ferramentasweb/images/logo1.png' %}" alt="Logo PsicoSimula" class="logo-title">
            <h1></h1>
            <div class="menu-item2">
                <div class="button-container">
                    <button class="button refresh-button">
                        <a href="#" id="refresh-link">
                            <img src="{% static 'ferramentasweb/images/Vector3.png' %}" alt="Ícone Gerar Caso" class="icon-white">
                            Gerar Novo Caso
                        </a>
                    </button>
                    <button class="button" id="button-historico">
                        <img src="{% static 'ferramentasweb/images/Historico.png' %}" alt="Ícone Histórico" class="icon-white">
                        Histórico
                    </button>
                    <button class="button" id="button-compartilhar">
                        <img src="{% static 'ferramentasweb/images/Download.png' %}" alt="Ícone Compartilhar" class="icon-white">
                        Compartilhar
                    </button>
                    <button class="button" id="button-personalizar">
                        <img src="{% static 'ferramentasweb/images/personalizar.png' %}" alt="Ícone Personalizar" class="icon-white">
                        Personalizar
                    </button>
                </div>
            </div>
            <div class="about">
                <div class="circle">
                    <img src="{% static 'ferramentasweb/images/logo4.png' %}" alt="Ícone" />
                </div>
                <h3>Sobre</h3>
                <p>Explore e gere casos clínicos hipotéticos para estudo em psicopatologia com o poder da inteligência artificial generativa. Encontre respostas e recursos que você precisa.</p>
            </div>
        </div>
        <div class="main-content">
            <h2>Casos Hipotéticos</h2>
            <img id="raio-image" src="{% static 'ferramentasweb/images/psicosimula.png' %}" alt="Ícone Informações">
            <!-- Modal para personalização -->
            <div id="customize-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>Personalize o Caso Clínico</h2>
                    <form id="customize-form">
                        <label for="idade">Idade:</label>
                        <input type="number" id="idade" name="idade" min="0" step="1">
            
                        <label for="sexo">Sexo:</label>
                        <select id="sexo" name="sexo">
                            <option value="">Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="outro">Outro</option>
                        </select>
            
                        <label for="historico-medico">Histórico Médico:</label>
                        <textarea id="historico-medico" name="historico-medico"></textarea>
            
                        <label for="contexto-social">Contexto Social:</label>
                        <textarea id="contexto-social" name="contexto-social"></textarea>
            
                        <button type="submit">Aplicar</button>
                    </form>
                </div>
            </div>
            <div class="chat-container">
                <div id="chat-box" class="hidden">
                    <div>
                        <img src="{% static 'ferramentasweb/images/Brilho.png' %}" alt="Ícone Resultado" class="result-image"/>
                    </div>
                    <!-- Mensagens da conversa serão adicionadas aqui -->
                </div>
                <div class="input-container">
                    <div class="textarea-wrapper">
                        <textarea id="user-input" placeholder="Informe o caso clínico"></textarea>
                        <button id="send-button" disabled>Simular</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Contêiner para o histórico, agora dentro da container -->
        <div id="history-box" class="hidden">
            <button class="close-btn">&times;</button>
            <div id="history-content"></div>
        </div>
    </div>

    <!-- Campo hidden para armazenar o ID do usuário -->
    <input type="hidden" name="user_id" value="{{ user_id }}">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatBox = document.getElementById('chat-box');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const refreshLink = document.getElementById('refresh-link');
            const buttonCompartilhar = document.getElementById('button-compartilhar');
            const buttonHistorico = document.getElementById('button-historico');
            const historyBox = document.getElementById('history-box');
            const historyContent = document.getElementById('history-content');
            const closeBtn = document.querySelector('#history-box .close-btn');
            const buttonPersonalizar = document.getElementById('button-personalizar');
            const customizeModal = document.getElementById('customize-modal');
            const closeCustomizeBtn = document.querySelector('#customize-modal .close-btn');
            const customizeForm = document.getElementById('customize-form');
            
            // Função para compartilhar o conteúdo da conversa
            function compartilharConteudoConsulta() {
                const mensagens = chatBox.querySelectorAll('.message');
                let consultaConteudo = '';
        
                mensagens.forEach(mensagem => {
                    consultaConteudo += mensagem.textContent + '\n'; // Concatena o conteúdo das mensagens
                });
        
                if (consultaConteudo.trim() === "") {
                    alert('Nenhuma consulta disponível para compartilhar.');
                    return;
                }
        
                // Compartilha o conteúdo concatenado
                if (navigator.share) {
                    navigator.share({
                        title: 'Consulta do PsicoSimula',
                        text: consultaConteudo.trim(),
                    })
                    .then(() => console.log('Consulta compartilhada com sucesso'))
                    .catch((error) => console.error('Erro ao compartilhar:', error));
                } else {
                    alert('O compartilhamento não é suportado neste dispositivo.');
                }
            }
        
            // Adiciona o evento ao botão de compartilhar
            buttonCompartilhar.addEventListener('click', compartilharConteudoConsulta);
        
            // Função para enviar a mensagem
            function sendMessage() {
                const userMessage = userInput.value.trim();
                if (userMessage !== '') {
                    addMessageToChat('user', userMessage);
                    processMessage(userMessage);
                    userInput.value = '';
                    sendButton.disabled = true;
                    chatBox.classList.remove('hidden');
                }
            }
        
            // Adiciona o evento ao botão de enviar
            sendButton.addEventListener('click', sendMessage);
        
            // Habilita o botão de enviar ao digitar no textarea
            userInput.addEventListener('input', function() {
                sendButton.disabled = userInput.value.trim() === '';
            });
        
            // Envia a mensagem ao pressionar Enter
            userInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });
        
            // Adiciona mensagem ao chat
            function addMessageToChat(sender, message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', sender);
                messageElement.textContent = message;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        
            // Processa a mensagem do usuário
            async function processMessage(message) {
                try {
                    const response = await fetch("{% url 'gerar_caso_stream' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ user_input: message })
                    });
        
                    if (!response.ok) throw new Error('Network response was not ok');
        
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedText = '';
                    let botMessageElement = null;
        
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
        
                        const chunk = decoder.decode(value, { stream: true });
                        const parsedChunks = chunk.split('\n').filter(chunk => chunk.trim() !== '');
        
                        parsedChunks.forEach(parsedChunk => {
                            try {
                                const jsonChunk = JSON.parse(parsedChunk);
                                if (jsonChunk.response) {
                                    accumulatedText = jsonChunk.response;
        
                                    if (!botMessageElement) {
                                        botMessageElement = document.createElement('div');
                                        botMessageElement.classList.add('message', 'bot');
                                        chatBox.appendChild(botMessageElement);
                                    }
        
                                    botMessageElement.textContent = accumulatedText;
                                    chatBox.scrollTop = chatBox.scrollHeight;
                                } else if (jsonChunk.error) {
                                    addMessageToChat('bot', jsonChunk.error);
                                }
                            } catch (error) {
                                addMessageToChat('bot', "Erro ao processar a resposta do servidor.");
                            }
                        });
                    }
                } catch (error) {
                    addMessageToChat('bot', "Erro ao se conectar com o servidor: " + error.message);
                }
            }
        
            // Evento para exibir o histórico ao clicar no botão "Histórico"
            buttonHistorico.addEventListener('click', function() {
                const userId = document.querySelector('input[name="user_id"]').value;
                fetch(`/get-history/?user_id=${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dados recebidos do histórico:', data); // Verifique no console
        
                        // Atualize o conteúdo do histórico
                        if (data.length > 0) {
                            historyContent.innerHTML = data.map(item => {
                                // Formate cada item do histórico
                                let formattedMessage = '';
                                if (item.role === 'system') {
                                    formattedMessage = `<strong>System:</strong> ${item.content}`;
                                } else if (item.role === 'user') {
                                    formattedMessage = `<strong>Você:</strong> ${item.content}`;
                                } else if (item.role === 'assistant') {
                                    formattedMessage = `<strong>Assistente:</strong> ${item.content}`;
                                }
                                return `<div>${formattedMessage}</div>`;
                            }).join('');
                        } else {
                            historyContent.innerHTML = '<p>Sem histórico disponível.</p>';
                        }
                        
                        // Exibir o histórico
                        historyBox.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Erro ao obter histórico:', error);
                    });
            });
        
            // Fechar o histórico ao clicar no botão de fechar
            closeBtn.addEventListener('click', function() {
                historyBox.style.display = 'none';
            });
        
            // Fechar o histórico ao clicar fora dele
            historyBox.addEventListener('click', function(event) {
                if (event.target === historyBox) {
                    historyBox.style.display = 'none';
                }
            });
        
            // Função para abrir o modal de personalização
            buttonPersonalizar.addEventListener('click', function() {
                customizeModal.classList.remove('hidden');
            });
        
            // Função para fechar o modal de personalização
            closeCustomizeBtn.addEventListener('click', function() {
                customizeModal.classList.add('hidden');
            });
        
            // Fechar o modal ao clicar fora dele
            customizeModal.addEventListener('click', function(event) {
                if (event.target === customizeModal) {
                    customizeModal.classList.add('hidden');
                }
            });
        
            // Função para enviar os dados de personalização
            customizeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Coletar dados do formulário
                const idade = document.getElementById('idade').value;
                const sexo = document.getElementById('sexo').value;
                const historicoMedico = document.getElementById('historico-medico').value;
                const contextoSocial = document.getElementById('contexto-social').value;
        
                // Enviar dados para o backend (exemplo de POST request)
                fetch('/personalizar-caso/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        idade,
                        sexo,
                        historico_medico: historicoMedico,
                        contexto_social: contextoSocial
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Dados de personalização enviados:', data);
                    customizeModal.classList.add('hidden');
                })
                .catch(error => console.error('Erro ao enviar dados de personalização:', error));
            });
        
            // Adiciona o evento ao botão de atualizar (refresh)
            refreshLink.addEventListener('click', function(event) {
                event.preventDefault();
                location.reload();
            });
        });
        
    </script>    
</body>
</html>
